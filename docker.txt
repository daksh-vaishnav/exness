docker run -d \
  --name mypg \
  -p 5431:5432 \
  -e POSTGRES_PASSWORD=postgres \
  -v pgdata:/var/lib/postgresql/data \
  postgres



docker run -d \
  --name my_redis \
  -p 6379:6379 \
  -v redisdata:/data \
  redis redis-server --appendonly yes


docker run -d \
  --name timescaledb \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_DB=trades \
  -p 5421:5432 \
  timescale/timescaledb:2.21.2-pg17




CREATE EXTENSION IF NOT EXISTS timescaledb;

SELECT create_hypertable('trades', 'T');

CREATE MATERIALIZED VIEW candles_1m
WITH (timescaledb.continuous) AS
SELECT time_bucket('1 minute', "T") AS bucket,
       s,
       first(p, "T") AS open,
       max(p)      AS high,
       min(p)      AS low,
       last(p, "T")  AS close,
       SUM(q)      AS volume
FROM trades
GROUP BY bucket, s;


CREATE MATERIALIZED VIEW candles_5m
WITH (timescaledb.continuous) AS
SELECT time_bucket('5 minutes', "T") AS bucket,
       s,
       first(p, "T") AS open,
       max(p)      AS high,
       min(p)      AS low,
       last(p, "T")  AS close,
       SUM(q)      AS volume
FROM trades
GROUP BY bucket, s;


SELECT time_bucket('5 minutes', bucket) AS bucket,
       s,
       first(open, bucket) AS open,
       max(high)           AS high,
       min(low)            AS low,
       last(close, bucket) AS close,
       SUM(volume)         AS volume
FROM candles_1m
WHERE s = 'XRPUSDT'
GROUP BY bucket, s
ORDER BY bucket;



Keep Them Updated
Enable automatic refresh policy so Timescale keeps aggregates up-to-date:

SELECT add_continuous_aggregate_policy('candles_1m',
    start_offset => INTERVAL '7 days',   -- how far back to refresh
    end_offset   => INTERVAL '1 minute', -- keep current data fresh
    schedule_interval => INTERVAL '1 minute'  -- how often to run refresh
);


SELECT add_continuous_aggregate_policy('candles_5m',
    start_offset => INTERVAL '30 days',
    end_offset   => INTERVAL '5 minutes',
    schedule_interval => INTERVAL '5 minutes'
);


Repeat for each aggregate (5m, 15m, 1d, etc.).


SELECT *
FROM candle_3m
WHERE s = 'BTCUSDT'
ORDER BY bucket desc;
